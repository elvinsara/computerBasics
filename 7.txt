using System;
using Microsoft.Graph;
using Microsoft.Identity.Client;
using System.Threading.Tasks;
using System.Collections.Generic;

namespace OutlookCalendarIntegration
{
    class Program
    {
        private static readonly string clientId = "YOUR_CLIENT_ID";
        private static readonly string tenantId = "YOUR_TENANT_ID";
        private static readonly string clientSecret = "YOUR_CLIENT_SECRET";

        static async Task Main(string[] args)
        {
            var events = await GetUpcomingEvents();
            if (events != null)
            {
                Console.WriteLine("Upcoming Events:");
                foreach (var calendarEvent in events)
                {
                    Console.WriteLine($"- {calendarEvent.Subject}: {calendarEvent.Start.DateTime}");
                }
            }
        }

        private static async Task<IList<Event>> GetUpcomingEvents()
        {
            try
            {
                var clientApp = ConfidentialClientApplicationBuilder.Create(clientId)
                    .WithClientSecret(clientSecret)
                    .WithAuthority($"https://login.microsoftonline.com/{tenantId}")
                    .Build();

                var authProvider = new ClientCredentialProvider(clientApp);
                var graphClient = new GraphServiceClient(authProvider);

                var events = await graphClient.Me.Events
                    .Request()
                    .Select(e => new { e.Subject, e.Start, e.End })
                    .OrderBy("start/dateTime")
                    .GetAsync();

                return events.CurrentPage;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error retrieving events: {ex.Message}");
                return null;
            }
        }
    }
}
