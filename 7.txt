using Microsoft.Graph;
using Microsoft.Identity.Client;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace OutlookCalendarIntegration
{
    class Program
    {
        private static readonly string clientId = "YOUR_CLIENT_ID";
        private static readonly string tenantId = "YOUR_TENANT_ID";

        static async Task Main(string[] args)
        {
            var events = await GetUpcomingEvents();
            if (events != null && events.Count > 0)
            {
                Console.WriteLine("Upcoming Events:");
                foreach (var calendarEvent in events)
                {
                    Console.WriteLine($"- {calendarEvent.Subject}: {calendarEvent.Start.DateTime}");
                }
            }
            else
            {
                Console.WriteLine("No upcoming events.");
            }
        }

        private static async Task<IList<Event>> GetUpcomingEvents()
        {
            try
            {
                var clientApp = PublicClientApplicationBuilder.Create(clientId)
                    .WithTenantId(tenantId)
                    .WithRedirectUri("http://localhost")
                    .Build();

                var scopes = new[] { "Calendars.Read" };
                var authResult = await clientApp.AcquireTokenInteractive(scopes).ExecuteAsync();

                var graphClient = new GraphServiceClient(new DelegateAuthenticationProvider(
                    requestMessage =>
                    {
                        requestMessage.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", authResult.AccessToken);
                        return Task.CompletedTask;
                    }));

                // Define query options for event start date
                var options = new List<QueryOption>
                {
                    new QueryOption("startDateTime", DateTime.Now.ToString("o")),
                    new QueryOption("endDateTime", DateTime.Now.AddDays(30).ToString("o"))
                };

                // Retrieve events with date filtering and properties selection
                var events = await graphClient.Me.CalendarView
                    .Request(options)
                    .Select("subject,start,end")
                    .OrderBy("start/dateTime")
                    .GetAsync();

                return events.CurrentPage;
            }
            catch (MsalException msalEx)
            {
                Console.WriteLine($"Authentication error: {msalEx.Message}");
            }
            catch (ServiceException svcEx)
            {
                Console.WriteLine($"Graph API request error: {svcEx.Message}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Unexpected error: {ex.Message}");
            }

            return null;
        }
    }
}
